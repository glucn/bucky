// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
  relationMode = "prisma"
}

enum AccountSubtype {
  asset
  liability
}

enum AccountType {
  user
  category
  system
}

enum AutoCategorizationMatchType {
  exact
  keyword
}

enum LiabilityTemplate {
  credit_card
  loan_mortgage
  personal_debt
  blank
}

enum LiabilityMinimumPaymentType {
  percent
  amount
  both
}

enum LiabilityPaymentFrequency {
  weekly
  biweekly
  monthly
}

enum LiabilityDueScheduleType {
  monthly_day
  weekly_weekday
  biweekly_weekday_anchor
}

enum LiabilityRepaymentMethod {
  fixed_payment
  fixed_principal
  manual_fixed_payment
}

model AccountGroup {
  id           String      @id @default(uuid())
  name         String
  accountType  AccountType
  displayOrder Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  accounts     Account[]
  
  @@unique([name, accountType])
  @@index([accountType, displayOrder])
}

model Account {
  id        String      @id @default(uuid())
  name      String
  type      AccountType
  subtype   AccountSubtype @default(asset)
  currency  String      @default("USD")
  isArchived Boolean   @default(false)
  archivedAt DateTime?
  groupId   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  lines     JournalLine[]
  checkpoints Checkpoint[]
  creditCardProperties CreditCardProperties[]
  liabilityProfile LiabilityProfile?
  investmentProperties InvestmentProperties?
  autoCategorizationRules AutoCategorizationRule[] @relation("AutoCategorizationRuleTarget")
  group     AccountGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  @@index([groupId])
}

model AutoCategorizationRule {
  id                      String                     @id @default(uuid())
  normalizedPattern       String
  matchType               AutoCategorizationMatchType
  targetCategoryAccountId String?
  lastConfirmedAt         DateTime?
  createdAt               DateTime                   @default(now())
  updatedAt               DateTime                   @updatedAt

  targetCategoryAccount Account? @relation("AutoCategorizationRuleTarget", fields: [targetCategoryAccountId], references: [id], onDelete: SetNull)

  @@unique([normalizedPattern, matchType])
  @@index([matchType, normalizedPattern])
  @@index([targetCategoryAccountId])
}

model JournalEntry {
  id           String        @id @default(uuid())
  date         String
  description  String?
  type         String?       // e.g., 'regular', 'currency_transfer'
  entryType    String?
  postingDate  String?       // Date posted to account (YYYY-MM-DD)
  displayOrder Float?        // Order for display, defaults to createdAt timestamp
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  lines        JournalLine[]
  
  @@index([displayOrder])
  @@index([entryType])
}

model JournalLine {
  id            String        @id @default(uuid())
  entryId       String
  accountId     String
  amount        Float         // Positive for debit, negative for credit (or vice versa, depending on convention)
  currency      String        // ISO 4217 currency code, e.g., 'USD', 'EUR'
  exchangeRate  Float?        // Optional, for currency-transfer transactions
  description   String?
  entry         JournalEntry  @relation(fields: [entryId], references: [id])
  account       Account       @relation(fields: [accountId], references: [id])
}

model Checkpoint {
  id            String   @id @default(uuid())
  accountId     String
  date          String
  balance       Float    // The target balance for the account
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  account       Account  @relation(fields: [accountId], references: [id])
}

model CreditCardProperties {
  id                    String   @id @default(uuid())
  accountId             String   
  creditLimit           Float    // Credit limit amount
  interestRate          Float    // Annual percentage rate (as decimal, e.g., 0.1899 for 18.99%)
  statementClosingDay   Int      // Day of month statement closes (1-31)
  paymentDueDay         Int      // Day of month payment is due (1-31)
  minimumPaymentPercent Float?   // Minimum payment as percentage (e.g., 0.02 for 2%)
  minimumPaymentAmount  Float?   // Minimum payment as fixed dollar amount
  
  // Versioning fields
  effectiveDate         String   // Date these properties became effective (YYYY-MM-DD)
  endDate               String?  // Date these properties ended (YYYY-MM-DD), null for current
  isActive              Boolean  @default(true) // Whether this is the current active version
  
  // Statement tracking (separate from properties versioning)
  lastStatementBalance  Float?   // Balance from last reconciled statement
  lastStatementDate     String?  // Date of last reconciled statement (YYYY-MM-DD)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId, effectiveDate])
  @@index([accountId, isActive])
}

model LiabilityProfile {
  id               String                  @id @default(uuid())
  accountId        String                  @unique
  template         LiabilityTemplate
  meta             String?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  account          Account                 @relation(fields: [accountId], references: [id], onDelete: Cascade)
  revolvingTerms   LiabilityRevolvingTerms?
  installmentTerms LiabilityInstallmentTerms?
  counterparty     LiabilityCounterparty?
  versions         LiabilityProfileVersion[]

  @@index([template])
}

model LiabilityRevolvingTerms {
  id                  String                      @id @default(uuid())
  profileId           String                      @unique
  limitOrCeiling      Float?
  statementClosingDay Int?
  paymentDueDay       Int?
  minimumPaymentType  LiabilityMinimumPaymentType?
  minimumPaymentPercent Float?
  minimumPaymentAmount  Float?
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt

  profile             LiabilityProfile            @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model LiabilityInstallmentTerms {
  id                    String                    @id @default(uuid())
  profileId             String                    @unique
  scheduledPaymentAmount Float?
  paymentFrequency      LiabilityPaymentFrequency?
  dueDayOfMonth         Int?
  dueWeekday            Int?
  anchorDate            String?
  paymentDueDay         Int?
  repaymentMethod       LiabilityRepaymentMethod?
  originalPrincipal     Float?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  profile               LiabilityProfile          @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model LiabilityCounterparty {
  id               String             @id @default(uuid())
  profileId        String             @unique
  counterpartyName String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  profile          LiabilityProfile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model LiabilityProfileVersion {
  id                     String                      @id @default(uuid())
  profileId              String
  effectiveDate          String
  template               LiabilityTemplate
  changeNote             String?
  counterpartyName       String?
  limitOrCeiling         Float?
  statementClosingDay    Int?
  paymentDueDay          Int?
  minimumPaymentType     LiabilityMinimumPaymentType?
  minimumPaymentPercent  Float?
  minimumPaymentAmount   Float?
  interestRate           Float?
  scheduledPaymentAmount Float?
  paymentFrequency       LiabilityPaymentFrequency?
  dueDayOfMonth          Int?
  dueWeekday             Int?
  anchorDate             String?
  repaymentMethod        LiabilityRepaymentMethod?
  originalPrincipal      Float?
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @updatedAt

  profile                LiabilityProfile            @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, effectiveDate])
  @@index([profileId, effectiveDate])
}

model InvestmentProperties {
  id              String   @id @default(uuid())
  accountId       String   @unique
  
  // Security identification
  tickerSymbol    String   // e.g., "AAPL", "VTSAX"
  securityType    String?  // "stock", "bond", "mutual_fund", "etf", etc.
  
  // Quantity tracking (shares/units)
  quantity        Float    @default(0) // Current number of shares owned
  
  // Cost basis method
  costBasisMethod String   @default("FIFO") // "FIFO" or "AVERAGE_COST"
  
  // Lot tracking for FIFO (stored as JSON)
  lots            String?  // JSON array of {date, quantity, pricePerShare, amount}
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([tickerSymbol])
}

model SecurityPriceHistory {
  id           String   @id @default(uuid())
  
  // Security identification
  tickerSymbol String   // e.g., "AAPL", "VTSAX"
  
  // Price data
  date         String   // Date of this price (YYYY-MM-DD)
  price        Float    // Market price per share on this date
  
  // Source tracking
  source       String?  // "manual", "import", "api", etc.
  
  createdAt    DateTime @default(now())
  
  @@unique([tickerSymbol, date])
  @@index([tickerSymbol, date])
}

model AppSetting {
  key       String   @id
  jsonValue String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SecurityMetadata {
  id            String    @id @default(uuid())
  ticker        String
  market        String
  displayName   String?
  assetType     String?
  quoteCurrency String?
  lastFetchedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([ticker, market])
  @@index([ticker, market])
}

model SecurityDailyPrice {
  id         String   @id @default(uuid())
  ticker     String
  market     String
  marketDate String
  close      Float
  fetchedAt  DateTime @default(now())
  createdAt  DateTime @default(now())

  @@unique([ticker, market, marketDate])
  @@index([ticker, market, marketDate])
}

model FxDailyRate {
  id             String   @id @default(uuid())
  sourceCurrency String
  targetCurrency String
  marketDate     String
  rate           Float
  fetchedAt      DateTime @default(now())
  createdAt      DateTime @default(now())

  @@unique([sourceCurrency, targetCurrency, marketDate])
  @@index([sourceCurrency, targetCurrency, marketDate])
}
