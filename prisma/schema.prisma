// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
  relationMode = "prisma"
}

enum AccountSubtype {
  asset
  liability
}

enum AccountType {
  user
  category
  system
}

model AccountGroup {
  id           String      @id @default(uuid())
  name         String
  accountType  AccountType
  displayOrder Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  accounts     Account[]
  
  @@unique([name, accountType])
  @@index([accountType, displayOrder])
}

model Account {
  id        String      @id @default(uuid())
  name      String
  type      AccountType
  subtype   AccountSubtype @default(asset)
  currency  String      @default("USD")
  isArchived Boolean   @default(false)
  archivedAt DateTime?
  groupId   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  lines     JournalLine[]
  checkpoints Checkpoint[]
  creditCardProperties CreditCardProperties[]
  group     AccountGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  @@index([groupId])
}

model JournalEntry {
  id           String        @id @default(uuid())
  date         String
  description  String?
  type         String?       // e.g., 'regular', 'currency_transfer'
  postingDate  String?       // Date posted to account (YYYY-MM-DD)
  displayOrder Float?        // Order for display, defaults to createdAt timestamp
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  lines        JournalLine[]
  
  @@index([displayOrder])
}

model JournalLine {
  id            String        @id @default(uuid())
  entryId       String
  accountId     String
  amount        Float         // Positive for debit, negative for credit (or vice versa, depending on convention)
  currency      String        // ISO 4217 currency code, e.g., 'USD', 'EUR'
  exchangeRate  Float?        // Optional, for currency-transfer transactions
  description   String?
  entry         JournalEntry  @relation(fields: [entryId], references: [id])
  account       Account       @relation(fields: [accountId], references: [id])
}

model Checkpoint {
  id            String   @id @default(uuid())
  accountId     String
  date          String
  balance       Float    // The target balance for the account
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  account       Account  @relation(fields: [accountId], references: [id])
}

model CreditCardProperties {
  id                    String   @id @default(uuid())
  accountId             String   
  creditLimit           Float    // Credit limit amount
  interestRate          Float    // Annual percentage rate (as decimal, e.g., 0.1899 for 18.99%)
  statementClosingDay   Int      // Day of month statement closes (1-31)
  paymentDueDay         Int      // Day of month payment is due (1-31)
  minimumPaymentPercent Float?   // Minimum payment as percentage (e.g., 0.02 for 2%)
  minimumPaymentAmount  Float?   // Minimum payment as fixed dollar amount
  
  // Versioning fields
  effectiveDate         String   // Date these properties became effective (YYYY-MM-DD)
  endDate               String?  // Date these properties ended (YYYY-MM-DD), null for current
  isActive              Boolean  @default(true) // Whether this is the current active version
  
  // Statement tracking (separate from properties versioning)
  lastStatementBalance  Float?   // Balance from last reconciled statement
  lastStatementDate     String?  // Date of last reconciled statement (YYYY-MM-DD)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId, effectiveDate])
  @@index([accountId, isActive])
}